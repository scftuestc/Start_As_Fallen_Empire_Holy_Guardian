#####################
# Capital buildings #
#####################
building_ancient_palace = {
    base_buildtime = @b2_time
    capital = yes
    can_build = no
    can_demolish = no
    can_be_ruined = no
    can_be_disabled = no
    position_priority = 0
    capital_tier = 5

    icon = building_palace

    category = government

    building_sets = {
        fallen_empire
    }
    # 堕落帝国才可建造（显示可建造）
    potential = {
        exists = owner
        owner = {
            is_fallen_empire = yes
            is_fallen_empire_hive = no
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
        }
    }

    allow = {
        sapient_pop_amount >= 1000
    }

    # 依据不同的政体，这个建筑会自动转换为列表中的某个建筑
    convert_to = {
        building_hive_major_capital
        building_machine_major_capital
        building_major_capital
        building_ancient_control_center
        building_major_capital_wilderness
    }

    planet_modifier = {
        planet_housing_add = 5000
        planet_amenities_add = 20000
        planet_stability_add = 20
        planet_defense_armies_add = 20
        planet_max_branch_office_buildings_add = 4
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_fallen_empire_spiritualist = no
            }
        }
        modifier = {
            # 岗位提供量翻倍
            job_fe_overseer_add = 400
            job_fe_protector_add = 400
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_fallen_empire_spiritualist = yes
                NOT = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
            }
        }
        modifier = {
            job_fe_sky_cardinal_add = 400
            job_fe_protector_add = 400
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_fallen_empire_spiritualist = yes
                has_origin = Start_As_Fallen_Empire_Holy_Guardians
            }
        }
        modifier = {
            # 换用我们自己定义的岗位
            job_safe_fe_sky_cardinal_add = 400
            job_safe_fe_protector_add = 400
        }
    }

    resources = {
        category = planet_buildings
        cost = {
            minerals = @b4_minerals
        }
        upkeep = {
            energy = 20
        }
    }

    prerequisites = { tech_fe_administration_2 }

    show_tech_unlock_if = {
        is_fallen_empire = yes
        is_fallen_empire_hive = no
    }

    upgrades = {
    }
}

###################
# Unity buildings #
###################
building_empyrean_shrine = {
    base_buildtime = @b2_time
    # 限制为一个星球只能建造一座
    planet_limit = 1
    can_build = yes
    can_demolish = yes
    position_priority = 1

    category = unity

    building_sets = {
        fallen_empire
        unity
    }

    # 只有圣卫才可建造
    potential = {
        exists = owner
        owner = {
            is_fallen_empire_spiritualist = yes
        }
        NOT = {
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_fallen_empire_spiritualist = yes
                NOT = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
            }
        }
        # 增添至600个
        job_fe_augur_add = 600
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_fallen_empire_spiritualist = yes
                has_origin = Start_As_Fallen_Empire_Holy_Guardians
            }
        }
        # 使用自定义的岗位
        job_safe_fe_augur_add = 600
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_tradition = tr_psionics_psi_corps}
        }
        pop_safe_fe_augur_bonus_workforce_mult = 0.5
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                NOR = {
                    has_tradition = tr_psionics_psi_corps
                    has_tradition = tr_psionics_shroud_psi_corps
                }
            }
        }
        planet_bureaucrats_produces_mult = 0.25
    }

    triggered_country_modifier = {
        potential = {
            has_shroud_dlc = no
            exists = owner
            owner = {
                has_country_flag = breached_shroud
            }
        }
        shroud_delve_cost = -0.25
    }
    triggered_country_modifier = {
        potential = {
            has_shroud_dlc = yes
            exists = owner
            owner = {
                has_country_flag = breached_shroud
            }
        }
        shroud_delve_cooldown = -0.1 # Delving doesn't cost anything in Shroud so it's changed
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
            minerals = @b4_minerals
        }
        upkeep = {
            alloys = @b2_alloy_upkeep
            energy = 20
            sr_zro = 2
        }
    }

    prerequisites = { tech_fe_administration_2 }

    show_tech_unlock_if = {
        is_fallen_empire_spiritualist = yes
    }
}

building_fe_temple_1 = {
    base_buildtime = @b2_time
    can_build = yes
    can_demolish = yes

    category = unity

    building_sets = {
        fallen_empire
        unity
    }

    potential = {
        exists = owner
        owner = {
            is_spiritualist = yes
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_administration_1
                has_country_flag = fe_administration_1_can_build # Using Administration 1 for this one instead of temple to avoid ethic swap shennanigans
            }
        }
        NOT = {
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = fe_administration_1_build_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_administration_1
                }
            }
        }
    }

    destroy_trigger = {
        exists = owner
        owner = { is_spiritualist = no }
    }

    convert_to = {
        building_fe_administration_1
        building_fe_administration_machine_1
        building_fe_administration_hive_1
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
            rare_crystals = @fe_sr_cost
        }
        upkeep = {
            rare_crystals = 2
            alloys = @b2_alloy_upkeep
            energy = 15
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            unity = 20
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    inline_script = {
        script = jobs/priests_add
        AMOUNT = @fe_jobs
    }

    upgrades = {
        building_fe_temple_2
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = fe_administration_1_build_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = fe_administration_1_build_count value = 1 }
        }
    }

    show_in_tech = tech_fe_administration_1

    show_tech_unlock_if = {
        OR = {
            is_spiritualist = yes
            has_make_spiritualist_perk = yes
        }
    }
}

building_fe_temple_2 = {
    base_buildtime = @b2_time
    can_build = no

    category = unity

    building_sets = {
        fallen_empire
        unity
    }

    potential = {
        exists = owner
        owner = {
            is_spiritualist = yes
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_administration_2
                has_country_flag = fe_administration_1_can_build
            }
        }
        NOT = {
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = fe_administration_1_upgrade_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_administration_2
                }
            }
        }
    }

    destroy_trigger = {
        exists = owner
        owner = {
            is_spiritualist = no
        }
    }

    convert_to = {
        building_fe_administration_2
        building_fe_administration_machine_2
        building_fe_administration_hive_2
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
        }
        upkeep = {
            rare_crystals = 2
            alloys = @b2_alloy_upkeep
            energy = 15
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            unity = 50
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    planet_modifier = {
        pop_housing_usage_mult = -0.15
    }

    inline_script = {
        script = jobs/priests_add
        AMOUNT = 800
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = fe_administration_1_upgrade_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = fe_administration_1_upgrade_count value = 1 }
        }
    }

    show_in_tech = tech_fe_administration_2

    show_tech_unlock_if = {
        OR = {
            is_spiritualist = yes
            has_make_spiritualist_perk = yes
        }
    }
}

#####################
# Science buildings #
#####################
building_fe_lab_1 = {
    base_buildtime = @b2_time
    can_build = yes
    can_demolish = yes

    category = research

    building_sets = {
        fallen_empire
        research
        physics
        society
        engineering
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_lab_1
                has_country_flag = fe_lab_1_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = fe_lab_1_build_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_lab_1
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
            exotic_gases = @fe_sr_cost
        }
        upkeep = {
            exotic_gases = 2
            alloys = @b3_alloy_upkeep
            energy = 30
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            physics_research = 25
            society_research = 25
            engineering_research = 25
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    inline_script = {
        script = jobs/researchers_add
        AMOUNT = 300
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_regular_empire = yes
                is_galactic_community_member = yes
            }
            is_active_resolution = "resolution_galacticstudies_extradimensional_experimentation"
            has_modifier = pm_extradimensional_experimentation
        }
        modifier = {
            job_physicist_add = 100
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_gestalt = yes
                is_galactic_community_member = yes
            }
            is_active_resolution = "resolution_galacticstudies_extradimensional_experimentation"
            has_modifier = pm_extradimensional_experimentation
        }
        modifier = {
            job_calculator_physicist_add = 100
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_physicist_bonus_workforce_mult = 0.10
        pop_safe_fe_biologist_bonus_workforce_mult = 0.10
        pop_safe_fe_engineer_bonus_workforce_mult = 0.10
    }

    upgrades = {
        building_fe_lab_2
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = fe_lab_1_build_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = fe_lab_1_build_count value = 1 }
        }
    }

    show_in_tech = tech_fe_lab_1
}

building_fe_lab_2 = {
    base_buildtime = @b2_time
    can_build = no

    category = research

    building_sets = {
        fallen_empire
        research
        physics
        society
        engineering
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_lab_2
                has_country_flag = fe_lab_1_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = fe_lab_1_upgrade_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_lab_2
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
        }
        upkeep = {
            exotic_gases = 3
            alloys = 8
            energy = 40
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            physics_research = 50
            society_research = 50
            engineering_research = 50
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }
    inline_script = {
        script = jobs/researchers_add
        AMOUNT = 600
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_regular_empire = yes
                is_galactic_community_member = yes
            }
            is_active_resolution = "resolution_galacticstudies_extradimensional_experimentation"
            has_modifier = pm_extradimensional_experimentation
        }
        modifier = {
            job_physicist_add = 200
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_gestalt = yes
                is_galactic_community_member = yes
            }
            is_active_resolution = "resolution_galacticstudies_extradimensional_experimentation"
            has_modifier = pm_extradimensional_experimentation
        }
        modifier = {
            job_calculator_physicist_add = 200
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_physicist_bonus_workforce_mult = 0.20
        pop_safe_fe_biologist_bonus_workforce_mult = 0.20
        pop_safe_fe_engineer_bonus_workforce_mult = 0.20
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = fe_lab_1_upgrade_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = fe_lab_1_upgrade_count value = 1 }
        }
    }

    show_in_tech = tech_fe_lab_2
}

##########################
# manufacturing buildings#
##########################
building_affluence_emporium = {
    base_buildtime = @b2_time
    can_build = yes
    can_demolish = yes
    icon = building_affluence_emporium

    category = manufacturing

    building_sets = {
        fallen_empire
        industrial
        factory
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_country_flag = affluence_emporium_can_build
                has_technology = tech_fe_affluence_1
            }
            is_hive_empire = no
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            owner = {
                OR = {
                    check_variable = { which = affluence_emporium_build_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_affluence_1
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
            rare_crystals = @fe_sr_cost
        }
        upkeep = {
            rare_crystals = 2
            alloys = 5
            minerals = 20
            energy = 20
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            consumer_goods = 100
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_acolyte_artisan_bonus_workforce_mult = 0.10
    }

    inline_script = {
        script = jobs/factory_add
        AMOUNT = @fe_jobs
    }

    planet_modifier = {
        planet_amenities_add = 1000
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = affluence_emporium_build_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = affluence_emporium_build_count value = 1 }
        }
    }

    upgrades = {
        building_affluence_center
    }

    show_in_tech = tech_fe_affluence_1
}

building_affluence_center = {
    base_buildtime = @b2_time
    can_build = no
    icon = building_affluence_center

    category = manufacturing

    building_sets = {
        fallen_empire
        industrial
        factory
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_affluence_2
                has_country_flag = affluence_emporium_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = affluence_emporium_upgrade_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_affluence_2
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
        }
        upkeep = {
            rare_crystals = 3
            alloys = 8
            minerals = 50
            energy = 30
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            consumer_goods = 200
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_acolyte_artisan_bonus_workforce_mult = 0.20
    }

    planet_modifier = {
        planet_amenities_add = 2000
        pop_happiness = 0.25
    }

    inline_script = {
        script = jobs/factory_add
        AMOUNT = 800
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = affluence_emporium_upgrade_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = affluence_emporium_upgrade_count value = 1 }
        }
    }

    show_in_tech = tech_fe_affluence_2
}

building_micro_forge = {
    base_buildtime = @b2_time
    can_build = yes
    can_demolish = yes

    category = manufacturing

    building_sets = {
        fallen_empire
        industrial
        foundry
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_forge_1
                has_country_flag = micro_forge_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            owner = {
                OR = {
                    check_variable = { which = micro_forge_build_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_forge_1
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    inline_script = {
        script = jobs/foundry_add
        AMOUNT = @fe_jobs
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
            volatile_motes = @fe_sr_cost
        }
        upkeep = {
            volatile_motes = 2
            energy = 30
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            alloys = 50
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_foundry_bonus_workforce_mult = 0.10
    }

    upgrades = {
        building_nano_forge
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = micro_forge_build_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = micro_forge_build_count value = 1 }
        }
    }

    show_in_tech = tech_fe_forge_1
}

building_nano_forge = {
    base_buildtime = @b2_time
    can_build = no

    category = manufacturing

    building_sets = {
        fallen_empire
        industrial
        foundry
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_forge_2
                has_country_flag = micro_forge_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = micro_forge_upgrade_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_forge_2
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    planet_modifier = {
        planet_structures_upkeep_mult = -0.05
    }

    inline_script = {
        script = jobs/foundry_add
        AMOUNT = 800
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
        }
        upkeep = {
            volatile_motes = 3
            energy = 40
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            alloys = 100
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_foundry_bonus_workforce_mult = 0.20
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = micro_forge_upgrade_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = micro_forge_upgrade_count value = 1 }
        }
    }

    show_in_tech = tech_fe_forge_2
}

######################
# Resource buildings #
######################
building_class_3_singularity = {
    base_buildtime = @b2_time
    can_build = yes
    can_demolish = yes

    category = resource

    building_sets = {
        fallen_empire
        fallen_empire_generator
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_singularity_1
                has_country_flag = class_3_singularity_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            owner = {
                OR = {
                    check_variable = { which = class_3_singularity_build_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_singularity_1
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    inline_script = {
        script = jobs/technicians_add
        AMOUNT = @fe_jobs
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = 900
            sr_dark_matter = 350
        }
        upkeep = {
            alloys = @b3_alloy_upkeep
            rare_crystals = 2
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            energy = 200
            trade = 20
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_acolyte_generator_bonus_workforce_mult = 0.10
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = class_3_singularity_build_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = class_3_singularity_build_count value = 1 }
        }
    }

    upgrades = {
        building_class_4_singularity
    }

    show_in_tech = tech_fe_singularity_1
}

building_class_4_singularity = {
    base_buildtime = @b2_time
    can_build = no

    category = resource

    building_sets = {
        fallen_empire
        fallen_empire_generator
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_singularity_2
                has_country_flag = class_3_singularity_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = class_3_singularity_upgrade_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_singularity_2
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    inline_script = {
        script = jobs/technicians_add
        # 增加至800个
        AMOUNT = 800
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = 1200
            sr_dark_matter = 50
        }
        upkeep = {
            alloys = 8
            rare_crystals = 3
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            energy = 300
            trade = 50
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_acolyte_generator_bonus_workforce_mult = 0.20
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = class_3_singularity_upgrade_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = class_3_singularity_upgrade_count value = 1 }
        }
    }

    show_in_tech = tech_fe_singularity_2
}

building_fe_mine_1 = {
    base_buildtime = @b2_time
    can_build = yes
    can_demolish = yes

    category = resource

    building_sets = {
        fallen_empire
        fallen_empire_mining
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_mine_1
                has_country_flag = fe_mine_1_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
        NOT = { is_planet_class = pc_ringworld_habitable }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = fe_mine_1_build_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_mine_1
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    inline_script = {
        script = jobs/miners_add
        AMOUNT = @fe_jobs
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
            volatile_motes = @fe_sr_cost
        }
        upkeep = {
            alloys = @b3_alloy_upkeep
            volatile_motes = 2
            energy = 20
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            minerals = 200
            trade = 25
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_acolyte_mine_bonus_workforce_mult = 0.1
    }

    upgrades = {
        building_fe_mine_2
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = fe_mine_1_build_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = fe_mine_1_build_count value = 1 }
        }
    }

    show_in_tech = tech_fe_mine_1
}

building_fe_mine_2 = {
    base_buildtime = @b2_time
    can_build = no

    category = resource

    building_sets = {
        fallen_empire
        fallen_empire_mining
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_mine_2
                has_country_flag = fe_mine_1_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
        NOT = { is_planet_class = pc_ringworld_habitable }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = fe_mine_1_upgrade_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_mine_2
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    inline_script = {
        script = jobs/miners_add
        # 增加至800
        AMOUNT = 800
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
        }
        upkeep = {
            alloys = 8
            volatile_motes = 3
            energy = 30
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            minerals = 400
            trade = 50
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_acolyte_mine_bonus_workforce_mult = 0.2
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = fe_mine_1_upgrade_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = fe_mine_1_upgrade_count value = 1 }
        }
    }

    show_in_tech = tech_fe_mine_2
}

building_nourishment_complex = {
    base_buildtime = @b2_time
    can_build = yes
    can_demolish = yes

    category = resource

    building_sets = {
        fallen_empire
        fallen_empire_farming
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_country_flag = nourishment_complex_can_build
                has_technology = tech_fe_nourishment_1
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            owner = {
                OR = {
                    check_variable = { which = nourishment_complex_build_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_nourishment_1
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    inline_script = {
        script = jobs/farmers_add
        AMOUNT = @fe_jobs
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
        }
        upkeep = {
            alloys = 5
            exotic_gases = 2
            energy = 20
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            food = 125
            trade = 25
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_acolyte_farm_bonus_workforce_mult = 0.10
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = nourishment_complex_build_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = nourishment_complex_build_count value = 1 }
        }
    }

    upgrades = {
        building_nourishment_center
    }

    show_in_tech = tech_fe_nourishment_1
}

building_nourishment_center = {
    base_buildtime = @b2_time
    can_build = no

    category = resource

    building_sets = {
        fallen_empire
        fallen_empire_farming
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_nourishment_2
                has_country_flag = nourishment_complex_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = nourishment_complex_upgrade_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_nourishment_2
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    planet_modifier = {
        pop_environment_tolerance = 0.10
    }

    inline_script = {
        script = jobs/farmers_add
        # 增加至800
        AMOUNT = 800
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b3_minerals
        }
        upkeep = {
            alloys = 8
            exotic_gases = 3
            energy = 30
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
        produces = {
            food = 200
            trade = 50
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = { has_origin = Start_As_Fallen_Empire_Holy_Guardians }
        }
        pop_safe_fe_acolyte_farm_bonus_workforce_mult = 0.20
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = nourishment_complex_upgrade_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = nourishment_complex_upgrade_count value = 1 }
        }
    }

    show_in_tech = tech_fe_nourishment_2
}

##################
# Army buildings #
##################
building_fe_fortress = {
    base_buildtime = @b2_time
    can_build = yes
    can_demolish = yes

    category = army

    building_sets = {
        fallen_empire
        fortress
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_fortress_1
                has_country_flag = fe_fortress_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            owner = {
                OR = {
                    check_variable = { which = fe_fortress_build_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_fortress_1
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    inline_script = {
        script = jobs/soldiers_add
        AMOUNT = @fe_jobs
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b2_minerals
            volatile_motes = @fe_sr_cost
        }
        upkeep = {
            alloys = @b2_alloy_upkeep
            volatile_motes = 2
            energy = 20
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    upgrades = {
        building_fe_stronghold
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = fe_fortress_build_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = fe_fortress_build_count value = 1 }
        }
    }

    show_in_tech = tech_fe_fortress_1
}

building_fe_stronghold = {
    base_buildtime = @b2_time
    can_build = no

    category = army

    building_sets = {
        fallen_empire
        fortress
    }

    potential = {
        exists = owner
        owner = {
            OR = {
                is_fallen_empire = yes
                has_technology = tech_fe_fortress_2
                has_country_flag = fe_fortress_can_build
            }
        }
        NOR = {
            has_modifier = resort_colony
            has_modifier = slave_colony
            has_modifier = penal_colony
        }
    }

    allow = {
        custom_tooltip = {
            fail_text = ancrel.10004.failtext
            exists = owner
            owner = {
                OR = {
                    check_variable = { which = fe_fortress_upgrade_count value >= 1 }
                    is_fallen_empire = yes
                    has_technology = tech_fe_fortress_2
                }
            }
        }
    }

    destroy_trigger = {
        always = no
    }

    planetary_ftl_inhibitor = yes

    inline_script = {
        script = jobs/soldiers_add
        AMOUNT = 800
    }

    planet_modifier = {
        planet_orbital_bombardment_damage = -0.25
    }

    resources = {
        category = planet_buildings
        cost = {
            alloys = @b2_minerals
        }
        upkeep = {
            alloys = @b2_alloy_upkeep
            volatile_motes = 3
            energy = 30
        }
        cost = {
            trigger = {
                owner = { is_wilderness_empire = yes }
            }
            biomass = @b3_biomass
        }
    }

    triggered_planet_modifier = {
        potential = {
            exists = owner
            owner = {
                is_wilderness_empire = yes
                has_tradition = tr_purity_finish
            }
        }
        planet_building_build_speed_mult = 0.03
        planet_decision_enact_speed_mult = 0.03
    }

    on_queued = {
        if = { # kill on the same planet
            limit = {
                is_variable_set = local_spent_biomass
                any_owned_pop_group = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
            }
            random_owned_pop_group = {
                limit = {
                    has_trait = trait_wilderness
                    pop_group_size > local_spent_biomass
                }
                kill_pop_group = {
                    pop_group = this
                    amount = local_spent_biomass
                }
            }
        }
        else_if = {
            limit = { is_variable_set = local_spent_biomass }
            owner = {
                global_biomass_spender = yes
            }
        }
        owner = {
            subtract_variable = { which = fe_fortress_upgrade_count value = 1 }
        }
    }

    on_unqueued = {
        unqueue_biomass_effect = yes
        owner = {
            change_variable = { which = fe_fortress_upgrade_count value = 1 }
        }
    }

    show_in_tech = tech_fe_fortress_2
}